/**
 * @file SVG代码转换工具
 * @version 1.0.0
 * @description 基于微信公众号平台规则和渲染特性，实现SVG交互图文 <svg> <img> <image> 三种格式相互转换
 * @author qiruo
 * @copyright Copyright (c) 2026 上海意符文化传媒有限公司
 * @license MIT License
 * @homepage https://www.ifsvgtool.com/
 * @demo https://www.ifsvgtool.com/code-converter
 * @repository https://github.com/qiruoKING/svg-code-convert
 *             https://gitee.com/forPage/svg-code-convert
 */
const svgCC={preservedAttrsList:["class","id","name","label","pointer-events","transform","opacity"],filterPreservedAttrs:function(t={}){var e,r,i={};for([e,r]of Object.entries(t))(this.preservedAttrsList.includes(e)||e.startsWith("data-"))&&(i[e]=r);return i},removeWidth:function(t){return t.filter(t=>""!==t.trim()).join(";").split(";").map(t=>t.trim()).filter(t=>!/^width\s*:/i.test(t)).join("; ").trim()},getImageRatio:function(r){return new Promise((i,t)=>{const o=document.createElement("img"),a=(o.style.position="absolute",o.style.visibility="hidden",o.style.width="auto",o.style.height="auto",o.style.opacity=0,document.body.appendChild(o),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o),t(new Error("图片加载超时"))},5e3));o.crossOrigin="anonymous",o.referrerPolicy="no-referrer",o.loading="eager",o.onload=function(){clearTimeout(a);let t=1;var e,r;o.naturalWidth&&o.naturalHeight?t=o.naturalWidth/o.naturalHeight:(o.style.width="100px",e=o.offsetWidth,r=o.offsetHeight,e&&r&&(t=e/r)),o.parentNode&&o.parentNode.removeChild(o),i(t)},o.onerror=function(){clearTimeout(a),o.parentNode&&o.parentNode.removeChild(o),t(new Error("图片加载失败"))};var e="proxy-image.php?url="+encodeURIComponent(r);o.src=e})},traverseHtmlTree:function(r,i,t=null,o=0){r&&"object"==typeof r&&!i(r,t,o)&&r.children&&Array.isArray(r.children)&&r.children.forEach((t,e)=>{this.traverseHtmlTree(t,i,{parentNode:r,childIndex:e},o+1)})},fosvg2image:function(t){this.traverseHtmlTree(t,(t,e)=>{if("foreignObject"===t.tag){var r,i,o,a,s,n=t.children.find(t=>"svg"===t.tag);if(n&&n.attrs?.["iftool-background"]&&0===n.children.length&&e?.parentNode?.children)return s={...t.attrs,...n.attrs},s=this.filterPreservedAttrs(s),r=[t.attrs.style||"",n.attrs.style||""],r=this.removeWidth(r),i=t.attrs.x||"0",o=t.attrs.y||"0",a=t.attrs.width||"100%",t=t.attrs.height||"100%",s={tag:"image",attrs:{...s,"iftool-href":n.attrs["iftool-background"]||(n.attrs.style.match(/url\((.*?)\)/)||[])[1]||"",x:i,y:o,width:a,height:t,style:r},children:[]},e.parentNode.children.splice(e.childIndex,1,s),!0}})},svg2image:function(t){this.traverseHtmlTree(t,(e,r)=>{if("svg"===e.tag&&(!e.children.some(t=>"animate"===t.tag&&"height"===t.attrs?.attributeName&&"-1"===t.attrs?.by)&&"foreignObject"!==r?.parentNode?.tag&&e.attrs?.["iftool-background"]&&r?.parentNode?.children)){var r=e.attrs.viewBox?e.attrs.viewBox.split(/\s+/).filter(Boolean):[],i=4<=r.length?r[2]:"100%",r=4<=r.length?r[3]:"100%";let t=e.attrs.style||"";t=t.replace(/\s*(transform|opacity)\s*:[^;]*;?\s*/g,"").trim();i={tag:"image",attrs:{"iftool-href":e.attrs["iftool-background"]||(e.attrs.style.match(/url\((.*?)\)/)||[])[1]||"",x:"0",y:"0",width:i,height:r,style:t},children:[]};return e.children.unshift(i),delete e.attrs["iftool-background"],!0}})},svg2img:function(t){return this.traverseHtmlTree(t,(t,e)=>{if("svg"===t.tag&&0===t.children.length&&t.attrs?.["iftool-background"]&&e?.parentNode?.children)return t={tag:"img",attrs:{...this.filterPreservedAttrs(t.attrs),"iftool-src":t.attrs["iftool-background"],style:t.attrs.style||""},children:[]},e.parentNode.children.splice(e.childIndex,1,t),!0}),t},image2img:function(t){return this.traverseHtmlTree(t,(t,e)=>{var r;if("image"===t.tag&&0===t.children.length&&t.attrs?.["iftool-href"]&&e?.parentNode?.children)return r=this.filterPreservedAttrs(t.attrs),r={tag:"g",attrs:{},children:[{tag:"foreignObject",attrs:{x:t.attrs.x||"0",y:t.attrs.y||"0",width:t.attrs.width||"100%",height:t.attrs.height||"100%"},children:[{tag:"img",attrs:{...r,"iftool-src":t.attrs["iftool-href"],style:t.attrs.style||""},children:[]}]}]},e.parentNode.children.splice(e.childIndex,1,r),!0}),t},image2svg:function(t){return this.traverseHtmlTree(t,(t,e)=>{var r,i,o;if("image"===t.tag&&0===t.children.length&&t.attrs?.["iftool-href"]&&e?.parentNode?.children)return o=this.filterPreservedAttrs(t.attrs),o={tag:"g",attrs:{},children:[{tag:"foreignObject",attrs:{x:t.attrs.x||"0",y:t.attrs.y||"0",width:r=t.attrs.width||"100%",height:i=t.attrs.height||"100%"},children:[{tag:"svg",attrs:{...o,viewBox:`0 0 ${r} `+i,style:t.attrs.style||"","iftool-background":t.attrs["iftool-href"]},children:[]}]}]},e.parentNode.children.splice(e.childIndex,1,o),!0}),t},foimg2image:function(t){return this.traverseHtmlTree(t,(t,e)=>{if("foreignObject"===t.tag&&e?.parentNode?.children){var r,i,o,a,s,n=t.children.find(t=>"img"===t.tag);if(n&&n.attrs?.["iftool-src"]&&0===n.children.length)return s={...t.attrs,...n.attrs},s=this.filterPreservedAttrs(s),r=[t.attrs.style||"",n.attrs.style||""],r=this.removeWidth(r),i=t.attrs.x||"0",o=t.attrs.y||"0",a=t.attrs.width||"100%",t=t.attrs.height||"100%",s={tag:"image",attrs:{...s,"iftool-href":n.attrs["iftool-src"],x:i,y:o,width:a,height:t,style:r},children:[]},e.parentNode.children.splice(e.childIndex,1,s),!0}}),t},img2image:async function(t){const o=[];this.traverseHtmlTree(t,(t,e)=>{var r,i;"img"===t.tag&&t.attrs?.["iftool-src"]&&e?.parentNode?.children&&(r="foreignObject"===e?.parentNode?.tag,i=!t.attrs.width&&!t.attrs.height,!r)&&i&&o.push({node:t,parentInfo:e})});for(const l of o){var{node:e,parentInfo:r}=l,i=this.filterPreservedAttrs(e.attrs);try{var a=await this.getImageRatio(e.attrs["iftool-src"]),s=Math.round(1080/a),n={tag:"svg",attrs:{viewBox:"0 0 1080 "+s,style:"display: block; pointer-events: painted; width: 100%;"},children:[{tag:"image",attrs:{...i,"iftool-href":e.attrs["iftool-src"],x:"0",y:"0",width:1080,height:s,style:e.attrs.style||""},children:[]}]};r.parentNode.children.splice(r.childIndex,1,n)}catch(t){i={tag:"svg",attrs:{viewBox:"0 0 100% 100%",style:"display: block; width: 100%;"},children:[{tag:"image",attrs:{...i,"iftool-href":e.attrs["iftool-src"],x:"0",y:"0",width:"100%",height:"100%"},children:[]}]};r.parentNode.children.splice(r.childIndex,1,i)}}return t},img2svg:async function(t){const r=[];this.traverseHtmlTree(t,(t,e)=>{"img"===t.tag&&0===t.children.length&&t.attrs?.["iftool-src"]&&e?.parentNode?.children&&r.push({node:t,parentInfo:e})});for(const l of r){var{node:e,parentInfo:i}=l,o=this.filterPreservedAttrs(e.attrs);try{var a=await this.getImageRatio(e.attrs["iftool-src"]),s=Math.round(1080/a),n={tag:"svg",attrs:{...o,viewBox:"0 0 1080 "+s,style:e.attrs.style||"","iftool-background":e.attrs["iftool-src"]},children:[]};i.parentNode.children.splice(i.childIndex,1,n)}catch(t){o={tag:"svg",attrs:{...o,viewBox:"0 0 100% 100%",style:e.attrs.style||"","iftool-background":e.attrs["iftool-src"]},children:[]};i.parentNode.children.splice(i.childIndex,1,o)}}return t},parse:function(t){var t=this.preprocess(t),t=(new DOMParser).parseFromString(t,"image/svg+xml"),e=t.querySelector("parsererror");if(e)throw e=e.textContent||e.innerText,new Error("XML解析失败。原因: "+e);return this.extractAssets(t.documentElement),this.domToObject(t.documentElement)},preprocess:function(t){return[t=>{var e=document.createElement("div");return e.innerHTML=t,e.innerHTML},t=>{const e=/(?:\s|^)data-src(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]+))?/gi;let r=t.replace(/(<img\s[^>]*>)/gi,t=>t.replace(e,""));return r=r.replace(/(?:\s|^)data-lazy-bgimg(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]+))?/gi,"")},t=>{return t.replace(/(?:\s|^)class\s*=\s*(["'])(?:.*?\s)?wx_imgbc_placeholder(?:\s.*?)?\1/gi,(t,e)=>{t=t.match(new RegExp(`class\\s*=\\s*${e}(.*?)`+e,"i"))[1].split(/\s+/).filter(t=>"wx_imgbc_placeholder"!==t.trim()).join(" ").trim();return t?" class="+e+t+e:""})},t=>{return t.replace(new RegExp("&(?!(amp|lt|gt|quot|nbsp|copy|yen|euro|deg|times|permil);)","g"),"&amp;")},t=>{return t.replace(/url\(\s*(?:"|&quot;)(.*?)(?:"|&quot;)\s*\)/gi,(t,e)=>`url('${e.trim()}')`)},t=>{const i=["img","br","input","hr"];var e=new RegExp(`<(${i.join("|")})(\\s+[^>]*?)?>`,"gi");return t.replace(e,(t,e,r="")=>{return!t.endsWith("/>")&&!t.includes("</")&&i.includes(e.toLowerCase())?`<${e}${r?r.replace(/\s*\/?$/,""):""}/>`:t})},t=>{const r=new Map;let i=0,o=t.replace(/<(pre|code|textarea)[\s\S]*?<\/\1>/gi,t=>{var e=`__PRE_PLACEHOLDER_${i}__`;return r.set(e,t),i++,e}).replace(/[\n\r]+/g," ").replace(/\t+/g," ").replace(/&nbsp;|&#160;|&#xA0;/gi," ").replace(/\s+/g," ").replace(/>\s+</g,"><").trim();return r.forEach((t,e)=>{o=o.replace(e,t)}),o},t=>{const i={animatetransform:"animateTransform",animatemotion:"animateMotion",foreignobject:"foreignObject"};const o={viewbox:"viewBox",calcmode:"calcMode",attributename:"attributeName",attributetype:"attributeType",keytimes:"keyTimes",keysplines:"keySplines",repeatcount:"repeatCount",repeatdur:"repeatDur"};var e;return t=t.replace(/<(\/?)(animatetransform|animatemotion|foreignobject)(?=\s|\/|>)/gi,(t,e,r)=>"<"+e+i[r.toLowerCase()]),e=Object.keys(o).join("|"),e=new RegExp(`([\\s>])(${e})=`,"gi"),t.replace(e,(t,e,r)=>""+e+o[r.toLowerCase()]+"=")},t=>`<div id="iftool">${t}</div>`].reduce((t,e)=>e(t),t)},extractAssets:function(t){for(var e,r,i,o=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT);e=o.nextNode();)"image"===e.tagName.toLowerCase()&&e.hasAttribute("href")&&(e.setAttribute("iftool-href",e.getAttribute("href")),e.removeAttribute("href")),"img"===e.tagName.toLowerCase()&&e.hasAttribute("src")&&(e.setAttribute("iftool-src",e.getAttribute("src")),e.removeAttribute("src")),e.hasAttribute("style")&&(r=e.getAttribute("style"),{bgProps:r,cleanedStyle:i}=this.processStyle(r),r.url&&(e.setAttribute("iftool-background",r.url),e.setAttribute("iftool-bg-color",r.color),e.setAttribute("iftool-bg-position",r.position),e.setAttribute("iftool-bg-size",r.size),e.setAttribute("iftool-bg-repeat",r.repeat),e.setAttribute("iftool-bg-attachment",r.attachment),e.setAttribute("iftool-bg-origin",r.origin),e.setAttribute("iftool-bg-clip",r.clip)),i?e.setAttribute("style",i):e.removeAttribute("style"))},processStyle:function(t){var e=document.createElement("div"),r=(e.style.cssText=t,{url:"",color:e.style.backgroundColor,position:e.style.backgroundPosition,size:e.style.backgroundSize,repeat:e.style.backgroundRepeat,attachment:e.style.backgroundAttachment,origin:e.style.backgroundOrigin,clip:e.style.backgroundClip}),e=e.style.backgroundImage,e=(e&&"none"!==e&&(e=e.match(/url\(\s*['"]?(.*?)['"]?\s*\)/))&&(r.url=e[1]),t.split(";").map(t=>t.trim()).filter(t=>t&&!/^background(-image|-position|-size|-repeat|-attachment|-origin|-clip|-color)?\s*:/i.test(t)).join("; "));return{bgProps:r,cleanedStyle:e}},domToObject:function(t){if(t.nodeType===Node.ELEMENT_NODE){var e={tag:t.tagName,attrs:{},children:[]};for(const o of t.attributes)e.attrs[o.name]=o.value;for(const a of t.childNodes){var r=this.domToObject(a);r&&e.children.push(r)}return e}var i;return t.nodeType===Node.TEXT_NODE?(i=t.textContent.trim())?{tag:"wenben",attrs:i,children:[]}:null:t.nodeType===Node.COMMENT_NODE?{tag:"zhushi",attrs:t.nodeValue.trim(),children:[]}:null},compose:function(t){var e=document.implementation.createDocument(null,null,null),e=this.objectToDom(e,t);let r=(new XMLSerializer).serializeToString(e);r=(r=(r=r.replace(/^(<[^\s>]+)([^>]*?)\s+xmlns="http:\/\/www\.w3\.org\/1999\/xhtml"/,"$1$2")).match(/<div id="iftool">(.*?)<\/div>/s)[1]).replace(/&amp;/g,"&");t=["section","p","div","svg","iframe","video","mp-common-clmusic","mp-common-redpacket","mp-common-profile","mp-common-videosnap","mp-common-mpaudio","mp-common-poi","mp-common-miniprogram","mp-common-vote"].join("|");return r=r.replace(new RegExp(`(<(${t})\\s+[^>]*?)/>`,"gi"),"$1></$2>")},objectToDom:function(t,e){if(!e)return null;if("wenben"===e.tag)return t.createTextNode(e.attrs);if("zhushi"===e.tag)return t.createComment(e.attrs);var r={backgroundUrl:e.attrs["iftool-background"],href:e.attrs["iftool-href"],srcUrl:e.attrs["iftool-src"],bgColor:e.attrs["iftool-bg-color"],bgPosition:e.attrs["iftool-bg-position"],bgSize:e.attrs["iftool-bg-size"],bgRepeat:e.attrs["iftool-bg-repeat"],bgAttachment:e.attrs["iftool-bg-attachment"],bgOrigin:e.attrs["iftool-bg-origin"],bgClip:e.attrs["iftool-bg-clip"]},i={...e.attrs};if(delete i["iftool-background"],delete i["iftool-href"],delete i["iftool-src"],delete i["iftool-bg-color"],delete i["iftool-bg-position"],delete i["iftool-bg-size"],delete i["iftool-bg-repeat"],delete i["iftool-bg-attachment"],delete i["iftool-bg-origin"],delete i["iftool-bg-clip"],r.backgroundUrl){var o=r.bgSize||"auto auto";let t=r.bgPosition||"0% 0%";o&&"auto"!==o&&"auto auto"!==o&&(t+=" / "+o);var o=`background: ${r.bgColor||"transparent"} url(${r.backgroundUrl}) ${t} ${r.bgRepeat||"repeat"} ${r.bgAttachment||"scroll"} ${r.bgOrigin||"padding-box"} `+(r.bgClip||"border-box"),a=i.style||"";i.style=a?a+"; "+o:o}r.href&&(i.href=r.href),r.srcUrl&&(i.src=r.srcUrl);var s=t.createElement(e.tag);for(const l in i)s.setAttribute(l,i[l]);if(e.children)for(const c of e.children){var n=this.objectToDom(t,c);n&&s.appendChild(n)}return s},parseStyle:function(t){const r={};return t&&t.split(";").forEach(t=>{var[t,e]=t.trim().split(":").map(t=>t.trim());t&&e&&(r[t]=e)}),r},calcLayer:function(t,e){const g=t=>{return!(!t||!t.tag)&&(t=t.tag.toLowerCase(),["svg","g","foreignObject"].includes(t))},a=t=>{t=parseFloat(t);return!isNaN(t)&&0<=t&&t<=.05},h=t=>{if(t&&"svg"===t.tag?.toLowerCase()&&t.children)for(const e of t.children)if("animate"===e.tag?.toLowerCase()&&e.attrs)if("width"===e.attrs.attributeName?.toLowerCase())return!0;return!1},p=(t,e)=>{let r=0;var i,o,t=this.parseStyle(t);return t.height&&(o=t.height.trim(),i=/^0(\s*px|\s*%|\s*rem|\s*em|\s*vh|\s*vw)?$/i.test(o),o=parseFloat(o),!isNaN(o))&&0===o&&i&&(r-=10),a(t.opacity)&&(r-=2),a(e?.attrs?.opacity)&&(r-=2),r},m=t=>{let e=0;var r,t=this.parseStyle(t);return t.marginTop&&(r=t.marginTop.trim(),/^-([1-9]\d*(\.\d+)?|0\.\d+)(%|\s*rem|\s*em|\s*vh|\s*vw)$/i.test(r))&&(e+=10),t.transform&&"none"!==t.transform&&(e+=5),"isolate"===t.isolation&&(e+=3),t.zIndex&&(r=Number(t.zIndex),!isNaN(r))&&0<r&&(e+=3),e};let o=0,s=0;const f=new Map,n=[],l=(e,r=[],t=null)=>{var i;e&&((i=e.attrs?.["iftool-src"]||e.attrs?.["iftool-href"]||e.attrs?.["iftool-background"]||"")&&(i={url:i,node:e,parentChain:r,parentNode:t,globalOrder:o++,childIndex:t?t.children.findIndex(t=>t===e):-1},n.push(i),t=[...r,e].reverse().filter(t=>"svg"===t.tag?.toLowerCase()).find(h))&&(t.__widthSvgId__||(t.__widthSvgId__=++s),t=t.__widthSvgId__,f.has(t)||f.set(t,[]),f.get(t).push(i)),e.children)&&e.children.forEach(t=>l(t,[...r,e],e))};l(t),f.forEach(t=>t.sort((t,e)=>t.globalOrder-e.globalOrder));var r=n.map(t=>{let{url:e,node:r,parentChain:i,globalOrder:o}=t,a=20;var t=[r.attrs?.style||"",...i.map(t=>t.attrs?.style||"")],s=t.reduce((t,e)=>t+p(e,r),0),t=(a+=s,t.reduce((t,e)=>t+m(e),0));a+=t;let n=0;const l=[...i].reverse().find(g);l&&(d=l.parentNode?.children.findIndex(t=>t===l)||0,n=3*d),a+=n;let c=0;var d=[...i,r].reverse().filter(t=>"svg"===t.tag?.toLowerCase()).find(h),d=(d&&(d=d.__widthSvgId__,-1<(d=(f.get(d)||[]).findIndex(t=>t.globalOrder===o)))&&(c=parseFloat((100-.05*d).toFixed(1))),a+=c,.01*(500-o));return a+=d,{url:e,layer:a=parseFloat(a.toFixed(2)),globalOrder:o,totalBottomScore:s,totalTopScore:t,gfoScore:n,animateScore:c,globalScore:d}});let i=[];0<r.length&&(c=r.sort((t,e)=>e.layer!==t.layer?e.layer-t.layer:t.globalOrder-e.globalOrder),i=c.slice(0,e).map(t=>t.url));var c=`<section class="用于提前加载的图片组，不影响画面内容，上传后不保留本段注释" style="display: block; height: 0px !important; margin-top: 0px !important; margin-bottom: 0px !important; padding-left: 1000px !important;">
			<svg viewBox="0 0 1 1">
				${i.map(t=>`<g><foreignObject x="0" y="0" width="1" height="1"><svg viewBox="0 0 1 1" style="background-image: url('${t}'); background-size: cover; background-repeat: no-repeat;"></svg></foreignObject></g>`).join("")}
			</svg>
		</section>`;const d=t=>{t&&(t.__widthSvgId__&&delete t.__widthSvgId__,t.children)&&t.children.forEach(d)};return d(t),{imagesDetail:r,finalHtml:c}}};
